machine:
  environment:
    MATPLOTLIBRC: mangaki/tests
  python:
    version: 3.5.2
dependencies:
  pre:
    - pip install -r requirements/dev.txt
database:
  override:
    - psql -d circle_test -c "create extension if not exists pg_trgm;
                              create extension if not exists unaccent"
    - cp .circle_mangaki_settings.ini mangaki/settings.ini
    - python mangaki/manage.py migrate
    - python mangaki/manage.py ranking
    - python mangaki/manage.py top director
test:
  pre:
    - python mangaki/manage.py collectstatic --no-input
  override:
    # FIXME: Figure out how to configure this thing.
    # - git lint --last-commit
    # Must:
    #   - run inside of the root folder
    #   - tell to nosetests how to find tests.
    #   - get the coverage and store a XUnit format in the $CIRCLE_TESTS_REPORTS folder.
    #   - cover only the package we care about (e.g. no third-party, migrations).
    - coverage run mangaki/manage.py test
      mangaki
      --with-coverage
      --with-xunit
      --xunit-file=$CIRCLE_TEST_REPORTS/nosetests.xml
      --cover-package=mangaki,irl,discourse
  post:
    # CodeCov MUST absolutely run in the project root folder
    - bash <(curl -s https://codecov.io/bash)
